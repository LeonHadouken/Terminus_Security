#!/bin/bash
# ==============================================
# MAIN SECURITY EXECUTION SCRIPT v2.0 (Parallel)
# Автоматическая настройка безопасности сервера
# ==============================================

# Включаем строгий режим, но отключаем его для блока многопоточности,
# так как ошибки в фоновых процессах обрабатываются через 'wait_for_tasks'
set -e

# --- ЗАГРУЗКА КОНФИГУРАЦИИ И БИБЛИОТЕК ---
if [ ! -f ./config.conf ] || [ ! -d ./lib ]; then
    echo "❌ Ошибка: Отсутствует config.conf или директория lib."
    echo "Убедитесь, что все файлы находятся в директориях, как указано в README.md."
    exit 1
fi

source ./config.conf
source ./lib/ui.sh
source ./lib/network.sh
source ./lib/protection.sh
source ./lib/monitoring.sh
source ./lib/tools.sh

# ==============================================
# ПРОВЕРКА КОНФИГУРАЦИИ
# ==============================================

check_config() {
    if [[ ! "$YOUR_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}❌ ОШИБКА: Вы не указали ваш IP или формат неверный!${NC}"
        echo ""
        read -p "Введите ваш IP адрес: " YOUR_IP

        if [[ ! "$YOUR_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            error "Неверный формат IP! Запустите скрипт снова."
            exit 1
        fi
        # Обновляем конфиг, чтобы не запрашивать IP снова при повторном запуске
        sed -i "s/^YOUR_IP=.*/YOUR_IP=\"$YOUR_IP\"/" config.conf
    fi

    echo -e "${GREEN}✅ Конфигурация принята:${NC}"
    echo "  Ваш IP: $YOUR_IP"
    echo "  Сервер: $SERVER_NAME"
    echo ""
}

# ==============================================
# ГЛАВНЫЙ СЦЕНАРИЙ
# ==============================================

main() {
    clear
    echo "========================================="
    echo "   COMPLETE SERVER SECURITY SETUP (PARALLEL)"
    echo "========================================="

    if [[ $EUID -ne 0 ]]; then
        error "Этот скрипт должен запускаться от root!"
        exit 1
    fi

    check_config

    # Обновляем пакеты (первый шаг)
    log "Обновление пакетов..."
    apt update && apt upgrade -y

    # ==========================================================
    # --- ЭТАП 1: СЕТЬ И АУТЕНТИФИКАЦИЯ (ПОСЛЕДОВАТЕЛЬНО) ---
    # Эти шаги критически важны и должны выполняться по порядку.
    # ==========================================================

    log "--- [ЭТАП 1/2: SSH и СЕТЬ] --- Настройка доступа и фаервола (Последовательно)"

    setup_ssh_keys          # 1. Генерируем ключи
    transfer_ssh_key        # 2. Передаем ключ на клиент
    clean_traces            # 3. Очищаем следы пароля
    setup_ssh_hardening     # 4. Запрещаем пароли, меняем порт
    setup_ufw               # 5. Настраиваем фаервол

    # ==========================================================
    # --- ЭТАП 2: ЗАЩИТА И МОНИТОРИНГ (МНОГОПОТОЧНО) ---
    # ==========================================================

    log "--- [ЭТАП 2/2: ЗАЩИТА] --- Настройка служб безопасности (Параллельно)"

    # Запускаем задачи в фоне с помощью start_task, который также логирует начало
    start_task setup_fail2ban "Установка и настройка Fail2Ban"
    start_task secure_logs "Защита системных логов (chattr +a)"
    start_task setup_audit "Настройка аудита системы (Auditd)"
    start_task install_security_tools "Установка сканеров (RKHunter, ClamAV, AIDE)"
    start_task setup_monitoring "Настройка мониторинга и отчетов Telegram"
    start_task honeypot_setup "Настройка Honeypot"
    start_task backup_configs "Создание бэкапа конфигураций"

    # Ожидаем завершения всех задач
    if ! wait_for_tasks; then
        error "Установка завершена с ошибками в одном или нескольких модулях. Проверьте логи выше."
    fi

    # --- 3. ЗАВЕРШЕНИЕ ---
    finalize

    # Предложение о перезагрузке
    log "Перезагрузка рекомендуется для применения всех настроек (особенно PAM и SSH)"
    read -p "Перезагрузить сейчас? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        reboot
    fi
}

# Запуск
main "$@"